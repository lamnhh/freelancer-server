<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard - Job Applications</title>
  <link href="/css/bootstrap.min.css" rel="stylesheet" />
  <link href="/font-awesome/css/font-awesome.css" rel="stylesheet" />
  <link href="/css/plugins/dataTables/datatables.min.css" rel="stylesheet" />
  <link href="/css/animate.css" rel="stylesheet" />
  <link href="/css/style.css" rel="stylesheet" />
  <link href="/css/plugins/toastr/toastr.min.css" rel="stylesheet">
</head>

<body>
  <div id="wrapper">
    <nav class="navbar-default navbar-static-side" role="navigation">
      <div class="sidebar-collapse">
        <ul class="nav metismenu" id="side-menu">
          <li class="nav-header">
            <div class="dropdown profile-element">
              <span>
                <img alt="image" class="img-circle" src="/img/pepe.jpg" style="width: 48px; height: 48px;" />
              </span>
              <a data-toggle="dropdown" class="dropdown-toggle" href="#">
                <span class="clear">
                  <span class="block m-t-xs">
                    <strong class="font-bold">Administrator</strong>
                  </span>
                  <span class="text-muted text-xs block">Administrator <b class="caret"></b></span>
                </span>
              </a>
            </div>
            <div class="logo-element">
              GIG
            </div>
          </li>
          <li>
            <a href="#">
              <i class="fa fa-th-large"></i>
              <span class="nav-label">Job Categories</span>
              <span class="fa arrow"></span>
            </a>
            <ul class="nav nav-second-level collapse">
              <li><a href="/job-type">View all categories</a></li>
              <li><a href="/job-type/new">Create new category</a></li>
            </ul>
          </li>
          <li class="active">
            <a href="/job-application">
              <i class="fa fa-address-card"></i>
              <span class="nav-label">Job Applications</span>
            </a>
          </li>
          <li>
            <a href="/refund">
              <i class="fa fa-address-card"></i>
              <span class="nav-label">Refund Requests</span>
            </a>
            </l>
        </ul>
      </div>
    </nav>

    <div id="page-wrapper" class="gray-bg">
      <div class="row border-bottom">
        <nav class="navbar navbar-static-top" role="navigation" style="margin-bottom: 0">
          <div class="navbar-header">
            <a class="navbar-minimalize minimalize-styl-2 btn btn-primary " href="#"><i class="fa fa-bars"></i>
            </a>
          </div>
          <ul class="nav navbar-top-links navbar-right">
            <li>
              <a href="/logout"> <i class="fa fa-sign-out"></i> Log out </a>
            </li>
          </ul>
        </nav>
      </div>
      <div class="row wrapper border-bottom white-bg page-heading">
        <div class="col-lg-10">
          <h2>List of Job Applications</h2>
          <ol class="breadcrumb">
            <li>
              <a href="/">Home</a>
            </li>
            <li class="active">
              <strong>Job Application</strong>
            </li>
          </ol>
        </div>
        <div class="col-lg-2"></div>
      </div>
      <div class="wrapper wrapper-content animated fadeInRight">
        <div class="row">
          <div class="col-lg-12">
            <div class="ibox float-e-margins">
              <div class="ibox-title">
                <h5>List of applications</h5>
                <div class="ibox-tools">
                  <a class="collapse-link">
                    <i class="fa fa-chevron-up"></i>
                  </a>
                  <a class="close-link">
                    <i class="fa fa-times"></i>
                  </a>
                </div>
              </div>
              <div class="ibox-content">
                <div class="table-responsive">
                  <table class="table table-striped table-bordered table-hover dataTables-example">
                    <thead>
                      <tr>
                        <th>Username</th>
                        <th>Category</th>
                        <th>Job Name</th>
                        <th>Status</th>
                        <th>Action</th>
                      </tr>
                    </thead>
                    <tbody id="tbl-content"></tbody>
                    <tfoot>
                      <tr>
                        <th>Username</th>
                        <th>Category</th>
                        <th>Job Name</th>
                        <th>Status</th>
                        <th>Action</th>
                      </tr>
                    </tfoot>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal" tabindex="-1" role="dialog" id="job-modal">
        <div class="modal-dialog modal-lg" role="document">
          <form class="modal-content">
            <div class="ibox-content">
              <h2 class="font-bold m-b-xs job-name">
                Desktop publishing software
              </h2>
              <p class="job-type">Many desktop publishing packages and web page editors now.</p>
              <hr>
              <div class="job-price-list">
                <div class="m-t-md">
                  <h2 class="product-main-price">$406,602 <small class="text-muted">Exclude Tax</small> </h2>
                </div>
                <div class="m-t-md">
                  <h2 class="product-main-price">$406,602 <small class="text-muted">Exclude Tax</small> </h2>
                </div>
              </div>
              <hr>

              <h4 style="margin-bottom: 10px">Applicant's CV</h4>
              <a target="_blank" class="job-cv"></a>
              <h4 style="margin-top: 25px">Job Description</h4>

              <div class="text-muted job-description">
                It is a long established fact that a reader will be distracted by the readable
                content of a page when looking at its layout. The point of using Lorem Ipsum is

                <br>
                <br>
                There are many variations of passages of Lorem Ipsum available, but the majority
                have suffered alteration in some form, by injected humour, or randomised words
                which don't look even slightly believable.
              </div>
            </div>
            <div class="modal-footer">
              <button class="btn btn-secondary btn-sm" type="button" data-dismiss="modal">Cancel</button>
              <button class="btn btn-danger btn-sm" type="button" onclick="approveJob(0);">Reject</button>
              <button class="btn btn-primary btn-sm" type="button" onclick="approveJob(1);">Approve</button>
            </div>
          </form>
        </div>
      </div>
      <div class="footer">
        <div><strong>Copyright</strong> Team 12 &copy; 2019-2020</div>
      </div>
    </div>
  </div>

  <!-- Mainly scripts -->
  <script src="/js/jquery-3.1.1.min.js"></script>
  <script src="/js/bootstrap.min.js"></script>
  <script src="/js/plugins/metisMenu/jquery.metisMenu.js"></script>
  <script src="/js/plugins/slimscroll/jquery.slimscroll.min.js"></script>

  <script src="/js/plugins/dataTables/datatables.min.js"></script>

  <!-- Custom and plugin javascript -->
  <script src="/js/inspinia.js"></script>
  <script src="/js/plugins/pace/pace.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/numeral.js/2.0.6/numeral.min.js"></script>

  <!-- Toastr -->
  <script src="/js/plugins/toastr/toastr.min.js"></script>

  <!-- Page-Level Scripts -->
  <script>
    let currentJobId = -1;
    let currentRowIndex = -1;

    function approveJob(status) {
      if (!confirm(`Are you sure you want to ${status ? "approve" : "reject"} this application?`)) {
        return;
      }
      fetch(`/api/job-admin/${currentJobId}/approve`, {
        method: "POST",
        body: JSON.stringify({ status }),
        headers: { "Content-Type": "application/json" }
      }).then(function (res) {
        if (res.ok) {
          location.reload();
        } else {
          res.json().then(function ({ message = "Internal Server Error" }) {
            toastr.error(message, "Error");
          })
        }
      })
    }

    function viewJob(job, rowIndex) {
      currentJobId = job.id;
      currentRowIndex = rowIndex;
      $(".job-name").html(job.name);
      $(".job-type").html(job.type);
      $(".job-cv").attr("href", job.cv_url).html(job.cv_url);
      $(".job-price-list").html(job.price_list.map(({ price, description }) => {
        return `
          <div class="m-t-md">
            <h2 class="product-main-price" style="position: relative;">
              ${numeral(price).format("$0,0")}
              <small class="text-muted" style="position:absolute;font-size:14px;left:12rem;top:50%;transform:translateY(-50%);">${description}</small>
            </h2>
          </div>
        `;
      }));
      $(".job-description").html(job.description);
      $("#job-modal").modal();
    }

    $(document).ready(function () {
      toastr.options = {
        closeButton: true,
        progressBar: true,
        showMethod: 'slideDown',
        timeOut: 4000
      };

      $(".dataTables-example").DataTable({
        pageLength: 10,
        responsive: true,
        dom: '<"html5buttons"B>lTfgitp',
        ajax: {
          url: "/api/job-admin",
          dataSrc: ""
        },
        columns: [{ data: "username" }, { data: "type" }, { data: "name" }, { data: "status" }, { data: null }],
        columnDefs: [
          {
            targets: 3,
            data: "status",
            render: function (_, _, row, meta) {
              if (row.status === null) {
                return `<span class="label label-secondary">NEW</span>`;
              }
              return `<span class="label label-warning">REJECTED</span>`;
            }
          },
          {
            targets: 4,
            data: null,
            render: function (_, _, row, meta) {
              return `<button class="btn btn-primary" onclick='viewJob(${JSON.stringify(row)}, ${meta.row})'>View more</button>`;
            }
          }
        ],
        buttons: [
          { extend: "copy" },
          { extend: "csv" },
          { extend: "excel", title: "ExampleFile" },
          { extend: "pdf", title: "ExampleFile" },
          {
            extend: "print",
            customize: function (win) {
              $(win.document.body).addClass("white-bg");
              $(win.document.body).css("font-size", "10px");
              $(win.document.body)
                .find("table")
                .addClass("compact")
                .css("font-size", "inherit");
            }
          }
        ]
      });
    });
  </script>
</body>

</html>